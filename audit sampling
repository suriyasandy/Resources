#!/usr/bin/env python3
"""
OMRC Audit Sampling Tool – v10.0
Rule-Based Stratified Sampling (Audit Ready)
"""

import tkinter as tk
from tkinter import ttk, filedialog, messagebox
import pandas as pd
import numpy as np
import os
from datetime import datetime


class AuditSamplingApp:

    def __init__(self, root):
        self.root = root
        self.root.title("Audit Sampling Tool – Rule Based Stratified")
        self.root.geometry("1800x1000")

        self.data = None
        self.selected_optional_cols = []
        self.stratum_stats = None
        self.sample_df = None

        self.build_ui()

    # ================= UI =================

    def build_ui(self):
        notebook = ttk.Notebook(self.root)
        notebook.pack(fill="both", expand=True)

        self.tab1 = ttk.Frame(notebook)
        self.tab2 = ttk.Frame(notebook)
        self.tab3 = ttk.Frame(notebook)
        self.tab4 = ttk.Frame(notebook)

        notebook.add(self.tab1, text="1. Data & Columns")
        notebook.add(self.tab2, text="2. Stratum & Risk Stats")
        notebook.add(self.tab3, text="3. Sampling Results")
        notebook.add(self.tab4, text="4. Documentation & Export")

        self.build_tab1()
        self.build_tab2()
        self.build_tab3()
        self.build_tab4()

    # ================= TAB 1 =================

    def build_tab1(self):
        frame = ttk.LabelFrame(self.tab1, text="Load Dataset", padding=10)
        frame.pack(fill="x")

        ttk.Button(frame, text="Load Data", command=self.load_data).pack(side="left")
        self.data_label = ttk.Label(frame, text="No data loaded", foreground="blue")
        self.data_label.pack(side="left", padx=10)

        cols = ttk.LabelFrame(self.tab1, text="Column Selection", padding=10)
        cols.pack(fill="x", pady=5)

        ttk.Label(cols, text="Region Column").grid(row=0, column=0)
        self.region_col = tk.StringVar(value="region")
        ttk.Combobox(cols, textvariable=self.region_col, width=25).grid(row=0, column=1)

        ttk.Label(cols, text="Product Column").grid(row=0, column=2, padx=10)
        self.product_col = tk.StringVar(value="product")
        ttk.Combobox(cols, textvariable=self.product_col, width=25).grid(row=0, column=3)

        ttk.Button(cols, text="Select Optional Columns", command=self.select_optional_columns)\
            .grid(row=0, column=4, padx=20)

        preview = ttk.LabelFrame(self.tab1, text="Data Preview", padding=10)
        preview.pack(fill="both", expand=True)

        self.preview_tree = ttk.Treeview(preview)
        self.preview_tree.pack(fill="both", expand=True)

    # ================= TAB 2 =================

    def build_tab2(self):
        ttk.Button(self.tab2, text="Calculate Stratum & Risk Stats",
                   command=self.calculate_stratum_stats).pack(pady=10)

        self.stats_tree = ttk.Treeview(
            self.tab2,
            columns=("Stratum", "Population", "RiskScore", "Percent"),
            show="headings"
        )
        self.stats_tree.pack(fill="both", expand=True)

        for c in ["Stratum", "Population", "RiskScore", "Percent"]:
            self.stats_tree.heading(c, text=c)
            self.stats_tree.column(c, width=300)

    # ================= TAB 3 =================

    def build_tab3(self):
        ttk.Button(self.tab3, text="Generate Sample",
                   command=self.generate_sample).pack(pady=10)

        self.sample_tree = ttk.Treeview(
            self.tab3,
            columns=("Metric", "Value"),
            show="headings"
        )
        self.sample_tree.pack(fill="x")

        self.unsampled_tree = ttk.Treeview(
            self.tab3,
            columns=("Stratum", "Population"),
            show="headings"
        )
        self.unsampled_tree.pack(fill="both", expand=True, pady=10)

        for c in ["Metric", "Value"]:
            self.sample_tree.heading(c, text=c)
            self.sample_tree.column(c, width=300)

        for c in ["Stratum", "Population"]:
            self.unsampled_tree.heading(c, text=c)
            self.unsampled_tree.column(c, width=400)

    # ================= TAB 4 =================

    def build_tab4(self):
        self.doc_text = tk.Text(self.tab4, wrap="word", font=("Arial", 10))
        self.doc_text.pack(fill="both", expand=True)

        export = ttk.Frame(self.tab4)
        export.pack(fill="x")

        ttk.Button(export, text="Export Sampled Data", command=self.export_sample).pack(side="left", padx=5)
        ttk.Button(export, text="Export Unsampled Strata", command=self.export_unsampled).pack(side="left", padx=5)
        ttk.Button(export, text="Export Stratum Stats", command=self.export_stats).pack(side="left", padx=5)
        ttk.Button(export, text="Export Documentation", command=self.export_doc).pack(side="left", padx=5)

    # ================= CORE LOGIC =================

    def load_data(self):
        path = filedialog.askopenfilename(filetypes=[("CSV", "*.csv"), ("Excel", "*.xlsx")])
        if not path:
            return

        self.data = pd.read_excel(path) if path.endswith(".xlsx") else pd.read_csv(path)
        self.data_label.config(text=f"Loaded {len(self.data)} records")

        self.preview_tree.delete(*self.preview_tree.get_children())
        cols = list(self.data.columns[:8])
        self.preview_tree["columns"] = cols
        self.preview_tree["show"] = "headings"

        for c in cols:
            self.preview_tree.heading(c, text=c)
            self.preview_tree.column(c, width=150)

        for _, r in self.data.head(25).iterrows():
            self.preview_tree.insert("", "end", values=list(r[cols]))

    def select_optional_columns(self):
        win = tk.Toplevel(self.root)
        win.title("Select Optional Columns")

        lb = tk.Listbox(win, selectmode="multiple", width=40)
        lb.pack()

        for c in self.data.columns:
            lb.insert("end", c)

        def confirm():
            self.selected_optional_cols = [lb.get(i) for i in lb.curselection()]
            win.destroy()

        ttk.Button(win, text="Confirm", command=confirm).pack(pady=5)

    def calculate_stratum_stats(self):
        r, p = self.region_col.get(), self.product_col.get()
        cols = [r, p] + self.selected_optional_cols

        self.data["stratum"] = self.data[cols].astype(str).agg("|".join, axis=1)

        stats = self.data.groupby("stratum").size().reset_index(name="population")
        total = len(self.data)
        stats["risk_score"] = stats["population"] / total
        stats["percent"] = stats["risk_score"] * 100

        self.stratum_stats = stats

        self.stats_tree.delete(*self.stats_tree.get_children())
        for _, s in stats.iterrows():
            self.stats_tree.insert("", "end",
                                   values=(s["stratum"], s["population"],
                                           f"{s['risk_score']:.4f}",
                                           f"{s['percent']:.2f}%"))

    def generate_sample(self):
        min_n, max_n = 300, 350
        total = len(self.data)
        target_n = min(max_n, max(min_n, int(total * 0.10)))

        samples = []
        for s, g in self.data.groupby("stratum"):
            samples.append(g.sample(1))

        base = pd.concat(samples)
        remaining = target_n - len(base)

        pool = self.data.drop(base.index)
        extra = pool.sample(n=min(remaining, len(pool)),
                            weights=pool["stratum"].map(
                                self.stratum_stats.set_index("stratum")["risk_score"]))

        self.sample_df = pd.concat([base, extra])

        self.sample_tree.delete(*self.sample_tree.get_children())
        self.sample_tree.insert("", "end", values=("Total Population", total))
        self.sample_tree.insert("", "end", values=("Total Strata", self.data["stratum"].nunique()))
        self.sample_tree.insert("", "end", values=("Final Sample Size", len(self.sample_df)))

        self.unsampled_tree.delete(*self.unsampled_tree.get_children())
        missed = set(self.data["stratum"]) - set(self.sample_df["stratum"])
        for m in missed:
            pop = len(self.data[self.data["stratum"] == m])
            self.unsampled_tree.insert("", "end", values=(m, pop))

        self.generate_documentation(target_n)

    # ================= EXPORTS =================

    def export_sample(self):
        self.sample_df.to_csv("sampled_data.csv", index=False)

    def export_unsampled(self):
        missed = set(self.data["stratum"]) - set(self.sample_df["stratum"])
        self.data[self.data["stratum"].isin(missed)].to_csv("unsampled_strata.csv", index=False)

    def export_stats(self):
        self.stratum_stats.to_csv("stratum_statistics.csv", index=False)

    def export_doc(self):
        with open("sampling_documentation.txt", "w") as f:
            f.write(self.doc_text.get("1.0", tk.END))

    def generate_documentation(self, target_n):
        self.doc_text.delete("1.0", tk.END)
        self.doc_text.insert(tk.END, f"""
AUDIT SAMPLING DOCUMENTATION

1. STRATUM DEFINITION
Strata were created using:
Region + Product + Optional user-selected attributes.

2. SAMPLE SIZE DETERMINATION
Lower Limit: 300
Upper Limit: 350
Final sample size selected: {len(self.sample_df)}

3. STRATUM COVERAGE RULE
At least ONE record was selected from each stratum.

4. REMAINING SAMPLE SELECTION
Remaining samples were selected using risk-weighted probability
based on stratum population proportion.

5. AUDIT ALIGNMENT
This approach aligns with ISA 530 and internal audit standards.
""")


def main():
    root = tk.Tk()
    AuditSamplingApp(root)
    root.mainloop()


if __name__ == "__main__":
    main()
