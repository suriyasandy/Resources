#!/usr/bin/env python3
"""
OMRC v9.0 – AUDIT COMPLIANT VERSION
----------------------------------
Changes applied:
✔ Removed legal_entity from mandatory fields
✔ Mandatory columns: region, product ONLY
✔ Stratum = region | product
✔ Minimum 1 sample per stratum
✔ Per-stratum sample size using ISA 530 / Cochran
✔ Threshold-driven sample sizing
✔ UI flow unchanged
"""

import tkinter as tk
from tkinter import ttk, filedialog, messagebox, Toplevel, Listbox, MULTIPLE
import pandas as pd
import numpy as np
from datetime import datetime
import os
from scipy import stats
import warnings

warnings.filterwarnings("ignore")


class OMRCRiskBasedSamplingTool:

    def __init__(self, root, out_dir_path):
        self.root = root
        self.root.title("OMRC Audit Sampling Tool v9.0 (Audit Compliant)")
        self.root.geometry("1700x1050")

        self.data = None
        self.comparison_results = {}
        self.stratum_stats = None

        # Threshold per stratum (auditor provided / editable)
        self.stratum_thresholds = {}

        self.results_dir = os.path.join(out_dir_path, "OMRC_Results")
        os.makedirs(self.results_dir, exist_ok=True)

        self.create_widgets()

    # =========================================================
    # UI (UNCHANGED FLOW)
    # =========================================================

    def create_widgets(self):
        notebook = ttk.Notebook(self.root)
        notebook.pack(fill="both", expand=True)

        self.tab1 = ttk.Frame(notebook)
        self.tab2 = ttk.Frame(notebook)
        self.tab3 = ttk.Frame(notebook)

        notebook.add(self.tab1, text="1. Data & Configuration")
        notebook.add(self.tab2, text="2. Risk Calculation")
        notebook.add(self.tab3, text="3. Sampling & Results")

        self.create_tab1_widgets()
        self.create_tab2_widgets()
        self.create_tab3_widgets()

    # =========================================================
    # TAB 1 – DATA CONFIG
    # =========================================================

    def create_tab1_widgets(self):

        frame = ttk.LabelFrame(self.tab1, text="Data Loading", padding=10)
        frame.pack(fill="x", pady=5)

        ttk.Button(frame, text="Load Data", command=self.load_data).pack(side="left")

        self.data_label = ttk.Label(frame, text="No data loaded", foreground="blue")
        self.data_label.pack(side="left", padx=20)

        mandatory = ttk.LabelFrame(self.tab1, text="MANDATORY COLUMNS", padding=10)
        mandatory.pack(fill="x", pady=5)

        ttk.Label(mandatory, text="Region Column").grid(row=0, column=0, sticky="w")
        self.region_col = ttk.Combobox(mandatory, width=25)
        self.region_col.grid(row=0, column=1, padx=5)

        ttk.Label(mandatory, text="Product Column").grid(row=0, column=2, sticky="w")
        self.product_col = ttk.Combobox(mandatory, width=25)
        self.product_col.grid(row=0, column=3, padx=5)

    # =========================================================
    # TAB 2 – RISK CALC
    # =========================================================

    def create_tab2_widgets(self):

        frame = ttk.LabelFrame(self.tab2, text="Risk Calculation", padding=10)
        frame.pack(fill="x", pady=5)

        ttk.Button(frame, text="Calculate Risk", command=self.calculate_risk).pack(side="left")

        self.risk_label = ttk.Label(frame, text="Not calculated", foreground="blue")
        self.risk_label.pack(side="left", padx=20)

    # =========================================================
    # TAB 3 – SAMPLING
    # =========================================================

    def create_tab3_widgets(self):

        frame = ttk.LabelFrame(self.tab3, text="Sampling Parameters", padding=10)
        frame.pack(fill="x", pady=5)

        ttk.Label(frame, text="Confidence Level").grid(row=0, column=0)
        self.confidence = ttk.Combobox(frame, values=["90%", "95%", "99%"], width=10)
        self.confidence.set("95%")
        self.confidence.grid(row=0, column=1)

        ttk.Label(frame, text="Margin of Error").grid(row=0, column=2)
        self.margin = ttk.Combobox(frame, values=["1%", "2%", "5%", "10%"], width=10)
        self.margin.set("5%")
        self.margin.grid(row=0, column=3)

        ttk.Button(frame, text="Generate Samples", command=self.generate_samples).grid(row=0, column=4, padx=20)

    # =========================================================
    # LOAD DATA
    # =========================================================

    def load_data(self):
        path = filedialog.askopenfilename(filetypes=[("CSV", "*.csv"), ("Excel", "*.xlsx")])
        if not path:
            return

        self.data = pd.read_csv(path) if path.endswith(".csv") else pd.read_excel(path)

        if "exception_id" not in self.data.columns:
            self.data.insert(0, "exception_id", range(1, len(self.data) + 1))

        cols = list(self.data.columns)
        self.region_col["values"] = cols
        self.product_col["values"] = cols

        self.data_label.config(text=f"Loaded {len(self.data)} records")

    # =========================================================
    # RISK CALCULATION (NO ENTITY)
    # =========================================================

    def calculate_risk(self):

        region = self.region_col.get()
        product = self.product_col.get()

        for c in [region, product]:
            if c not in self.data.columns:
                messagebox.showerror("Error", f"Column missing: {c}")
                return

        # Simple transparent risk proxy
        region_freq = self.data[region].value_counts(normalize=True)
        product_freq = self.data[product].value_counts(normalize=True)

        self.data["risk_score"] = (
            self.data[region].map(region_freq).fillna(0.5) * 0.5 +
            self.data[product].map(product_freq).fillna(0.5) * 0.5
        )

        # Stratum definition (AUDIT FIX)
        self.data["stratum"] = (
            self.data[region].astype(str) + "|" +
            self.data[product].astype(str)
        )

        # Default thresholds
        self.stratum_thresholds = {
            s: 0.05 for s in self.data["stratum"].unique()
        }

        self.risk_label.config(text="Risk calculated", foreground="green")

    # =========================================================
    # SAMPLE SIZE – ISA 530
    # =========================================================

    def calculate_stratum_sample_size(self, N, threshold):

        confidence = float(self.confidence.get().strip("%")) / 100
        error = float(self.margin.get().strip("%")) / 100

        Z = stats.norm.ppf((1 + confidence) / 2)
        p = threshold

        n = (Z ** 2 * p * (1 - p)) / (error ** 2)
        n_adj = n / (1 + n / N)

        return max(1, int(np.ceil(n_adj)))

    # =========================================================
    # SAMPLE GENERATION (AUDIT LOGIC)
    # =========================================================

    def generate_samples(self):

        samples = []

        for stratum, grp in self.data.groupby("stratum"):

            N = len(grp)
            threshold = self.stratum_thresholds.get(stratum, 0.05)

            n_required = self.calculate_stratum_sample_size(N, threshold)

            # Mandatory one sample
            mandatory = grp.sample(n=1, random_state=42)

            remaining = grp.drop(mandatory.index)

            if n_required > 1:
                fill = remaining.sort_values("risk_score", ascending=False).head(n_required - 1)
            else:
                fill = pd.DataFrame()

            samples.append(pd.concat([mandatory, fill]))

        final_sample = pd.concat(samples).reset_index(drop=True)

        ts = datetime.now().strftime("%Y%m%d_%H%M%S")
        out = os.path.join(self.results_dir, f"audit_sample_{ts}.csv")
        final_sample.to_csv(out, index=False)

        messagebox.showinfo(
            "Success",
            f"Audit sample generated\n"
            f"Total samples: {len(final_sample)}\n"
            f"Strata covered: {final_sample['stratum'].nunique()}\n\n"
            f"Saved to:\n{out}"
        )


# =========================================================
# RUN
# =========================================================

def main():
    root = tk.Tk()
    out_dir = os.path.expanduser("~")
    app = OMRCRiskBasedSamplingTool(root, out_dir)
    root.mainloop()


if __name__ == "__main__":
    main()
