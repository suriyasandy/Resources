import pandas as pd
import numpy as np
import joblib

from sklearn.model_selection import train_test_split
from sklearn.preprocessing import OneHotEncoder
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.linear_model import LogisticRegression

# Load prepared Phase-1++ dataset
df = pd.read_csv("training_data.csv")

FEATURES = [
    "product_group",
    "tenor_bucket",
    "liquidity_window",
    "principal_bucket",
    "ccy_liquidity",
    "cluster_trade_count"
]

TARGET = "explainable_label"

X = df[FEATURES]
y = df[TARGET]

cat_features = FEATURES[:-1]
num_features = ["cluster_trade_count"]

preprocessor = ColumnTransformer(
    [
        ("cat", OneHotEncoder(handle_unknown="ignore"), cat_features),
        ("num", "passthrough", num_features),
    ]
)

model = Pipeline(
    steps=[
        ("prep", preprocessor),
        ("clf", LogisticRegression(max_iter=500))
    ]
)

model.fit(X, y)

joblib.dump(model, "model.pkl")
joblib.dump(preprocessor, "preprocessor.pkl")

print("Model trained & saved")
